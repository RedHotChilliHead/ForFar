# ForFar

Тестовое задание для разработчика на python.
У сети ресторанов доставки "ФорФар" есть множество точек, на которых готовятся заказы для клиентов. Каждый клиент хочет вместе с заказом
получить чек, содержащий детальную информацию о заказе. Сотрудники кухни также хотят чек, чтобы в процессе готовки и упаковки заказа не забыть
положить всё что нужно. Наша задача помочь и тем и другим, написав сервис для генерации чеков.

## Описание

1. Проект позволяет получать заказы от ERP с помощью POST-запроса к API по адресу /forfar/create_checks/.
Далее API создает чеки для клиентов и кухни в БД для всех принтеров заведения (статус чека-new).
2. API ставит в очередь асинхронные задачи на генерацию PDF-файлов для этих чеков,
также предусмотрен способ поставить задачу в очередь вручную с помощью функции generate_checks.
3. Асинхронный воркер берет задачи из очереди и генерирует HTML из Django-шаблона и PDF-файл из HTML (статус чека-rendered) с помощью функции generate_pdf.
Redis используется как брокер задач для celery.
4. Приложение запрашивает список доступных чеков для печати (в статусе rendered) по адресу new_checks/.
5. Приложение скачивает pdf-файл по адресу check/ и печатает его (статус чека-printed).

## Установка и запуск

Для запуска всей инфраструктуры, необходимой для работы сервиса, используется Docker и Docker Compose.

1. Убедитесь, что у вас установлены Docker и Docker Compose.
2. Клонируйте репозиторий проекта.

```
git clone https://github.com/RedHotChilliHead/ForFar.git
```
3. Установите зависимости.
```
pip install -r requirements.txt
```
3. Соберите и запустите контейнер Docker командами:
```
docker-compose build wkhtmltopdf
docker-compose up --build
```
4. Запустите celery c пулом процессов.
```
cd ForFar
celery -A ForFar worker --loglevel=DEBUG -P gevent
```
5. Запустите Flower для мониторинга задач (не обязательно).
```
celery -A ForFar flower
```
Мониторинг будет доступен по адресу http://localhost:5555.

6. Запустите проект Django.
```
cd ForFar
python manage.py runserver
```
Проект будет доступен по адресу http://localhost:8000/forfarapp/.

## Использование

### API

#### Отправьте заказ с помощью POST-запроса к API по адресу /forfar/create_checks/

#### URL

```http
http://127.0.0.1:8000/forfar/create_checks/
```
#### Пример запроса

```http
POST
Content-Type: application/json
Body: {
  "id": 123458,
  "items": [{"name": "Поке с лососем", "quantity": 1, "unit_price": 700}],
  "price": 700,
  "client": {"name": "Ира", "phone": 9173332225},
  "address": "г. Нижний Новгород, ул. Ленина, д. 42",
  "point_id": 3
}
```
Для того, что бы вручную поставить задачу в очередь воспользуйтесь url
`http://127.0.0.1:8000/forfar/generate-checks/<int:check_id>/`, где check_id - первичный ключ чека

Сообщения об ошибках:

- при попытке создать чеки для уже имеющегося заказа: {"error": "Для данного заказа уже созданы чеки"};
- при попытке создать чеки для точки, не имеющей принтеров: {"error": "Для данной точки не настроено ни одного принтера"};
- в случае успешного создания чеков: {"ok": "Чеки успешно созданы"}.

#### Запросите список доступных чеков для печати

#### URL

```http
http://127.0.0.1:8000/forfar/new_checks/
```
#### Пример запроса

```http
GET
http://127.0.0.1:8000/forfar/new_checks/?api_key=generated_api_key_3
```
, где api_key, это уникальный api-ключ принтера

В случае указания неправильного api-key в запросе будет возвращено сообщение об ошибке авторизации: {"error": "Ошибка авторизации"}.
#### Скачайте pdf-файл и распечатайте

#### URL

```http
http://127.0.0.1:8000/forfar/check/
```
#### Пример запроса

```http
GET
http://127.0.0.1:8000/forfar/check/?api_key=generated_api_key_3&check_id=5
```
, где api_key, это уникальный api-ключ принтера, а check_id - первичный ключ чека, предназначенного для печати на этом принтере

Сообщения об ошибках:

- при попытке скачать чек, не предусмотренный для печати на данном принтере (или неверного api-key): {"error": "Ошибка авторизации"};
- при попытке скачать чек с первичным ключом, отсутствующим в БД: {"error": "Данного чека не существует"};
- если воркер не успел сгенерировать PDF файл: {"error": "Для данного чека не сгенерирован PDF-файл"};
- если сгенерированный PDF файл отсутствует по указанному пути: {"error": "PDF-файл не найден"}.

### Администратичная панель

В проекте предусмотрено администрирование чеков и принтеров, доступ осуществляется по адресу http://localhost:8000/admin. 
Логин "admin", пароль "admin".
